<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Facility Management Online (GitHub-backed)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Original styles (kept mostly intact) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%); min-height: 100vh; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 1200px; width: 100%; margin: 0 auto; }
        header { text-align: center; margin: 30px 0; padding: 20px; position: relative; }
        h1 { color: #2c3e50; font-size: 2.4rem; margin-bottom: 6px; text-shadow: 1px 1px 3px rgba(0,0,0,0.05); }
        .subtitle { color: #7f8c8d; font-size: 1rem; margin-bottom: 18px; }
        .github-config { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:12px; }
        .github-config input { padding:8px 10px; border-radius:6px; border:1px solid #dce4ec; }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display:inline-flex; align-items:center; gap:8px; }
        .btn-primary { background:#3498db; color:white; }
        .btn-primary:hover { background:#2980b9; }
        .btn-ghost { background:transparent; color:#34495e; border:1px solid #eaeff5; }
        .main-content { background:white; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow:hidden; margin-bottom:30px; width:100%; }
        .nav-tabs { display:flex; background:#f8fafc; border-bottom:1px solid #eaeff5; }
        .nav-tab { padding:14px 20px; cursor:pointer; font-weight:600; color:#7f8c8d; border-bottom:3px solid transparent; transition:all 0.2s; }
        .nav-tab.active { color:#3498db; border-bottom:3px solid #3498db; background:white; }
        .tab-content { display:none; padding:20px; }
        .tab-content.active { display:block; }
        .form-section { padding:20px; background:#f8fafc; border-bottom:1px solid #eaeff5; }
        .form-title { color:#2c3e50; margin-bottom:12px; font-size:1.2rem; display:flex; align-items:center; gap:10px; }
        .form-row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
        .input-group { flex:1; min-width:200px; display:flex; flex-direction:column; gap:6px; }
        label { color:#34495e; font-weight:500; font-size:0.9rem; }
        input, select { width:100%; padding:10px 12px; border:1px solid #dce4ec; border-radius:8px; font-size:0.95rem; }
        input:focus, select:focus { border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,0.12); outline:none; }
        .grid-section { padding:20px; overflow-x:auto; }
        .grid-container { display:grid; grid-template-columns:repeat(3,1fr); gap:18px; margin-top:14px; }
        .facility-card { background:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.06); padding:18px; display:flex; flex-direction:column; align-items:center; transition:all 0.2s; border:1px solid #eaeff5; text-decoration:none; color:inherit; }
        .facility-card:hover { transform:translateY(-5px); box-shadow:0 8px 25px rgba(0,0,0,0.09); }
        .card-icon { font-size:2.8rem; margin-bottom:12px; color:#3498db; border-radius:50%; width:72px; height:72px; display:flex; align-items:center; justify-content:center; background:#f8fafc; }
        .card-title { font-size:1.05rem; font-weight:600; color:#2c3e50; margin-bottom:6px; text-align:center; width:100%; }
        .card-group { background:#e3f2fd; color:#3498db; padding:5px 10px; border-radius:16px; font-size:0.82rem; font-weight:500; margin-bottom:10px; }
        .empty-message { text-align:center; padding:30px; color:#7f8c8d; font-style:italic; grid-column:1 / -1; }
        .admin-card .card-actions { display:flex; gap:10px; margin-top:10px; }
        .btn-edit { background:#2ecc71; color:white; padding:8px 12px; border-radius:6px; border:none; }
        .btn-delete { background:#e74c3c; color:white; padding:8px 12px; border-radius:6px; border:none; }
        footer { text-align:center; padding:12px; color:#7f8c8d; font-size:0.9rem; width:100%; }
        .notification { position:fixed; top:20px; right:20px; padding:12px 18px; border-radius:8px; color:white; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.12); transform:translateX(150%); transition:transform .25s ease; z-index:1000; }
        .notification.show { transform:translateX(0); }
        .notification.success { background:#2ecc71; }
        .notification.error { background:#e74c3c; }
        @media (max-width:1024px) { .grid-container { grid-template-columns:repeat(2,1fr); } }
        @media (max-width:768px) {
            .form-row { flex-direction:column; gap:10px; }
            .grid-container { grid-template-columns:1fr; }
            .nav-tabs { flex-direction:column; }
            .nav-tab { border-bottom:1px solid #eaeff5; border-left:3px solid transparent; }
            .nav-tab.active { border-left:3px solid #3498db; }
        }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:520px; box-shadow:0 10px 30px rgba(0,0,0,0.18); }
        .icon-options { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin:12px 0; }
        .icon-option { display:flex; flex-direction:column; align-items:center; padding:10px; border-radius:8px; cursor:pointer; }
        .icon-option.selected { background:#e3f2fd; border:2px solid #3498db; }
        .icon-option i { font-size:1.6rem; color:#3498db; }
        .editable-input { width:100%; padding:8px 10px; border:1px solid #3498db; border-radius:6px; font-size:1rem; }
        .group-selector { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
        .group-btn { padding:8px 12px; background:#f8fafc; border:1px solid #eaeff5; border-radius:20px; cursor:pointer; transition:all .15s; font-size:0.9rem; }
        .group-btn.active { background:#3498db; color:white; border-color:#3498db; }
        .loading { display:inline-block; width:18px; height:18px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite; margin-right:8px; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .small-note { font-size:0.85rem; color:#7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-building"></i> Facility Management (GitHub-backed)</h1>
            <p class="subtitle">Data is stored in a GitHub repository file (no localStorage for facility data)</p>

            <div class="github-config" id="github-config">
                <!-- User provides repo information & token. Token is kept in-memory only during session. -->
                <input id="gh-owner" placeholder="owner (user or org)" />
                <input id="gh-repo" placeholder="repo name" />
                <input id="gh-path" placeholder="path (data/facilities.json)" value="data/facilities.json" />
                <input id="gh-branch" placeholder="branch" value="main" style="width:110px" />
                <input id="gh-token" placeholder="Personal Access Token (repo scope)" type="password" style="min-width:260px" />
                <button class="btn btn-primary" id="btn-connect"><i class="fas fa-link"></i> Connect</button>
                <button class="btn btn-ghost" id="btn-clear"><i class="fas fa-eraser"></i> Clear</button>
            </div>

            <p class="small-note" style="margin-top:10px;">
                Security note: For demos you may paste a Personal Access Token (PAT). For production, use a server-side component or a GitHub App. PAT will not be stored in localStorage by this page.
            </p>
        </header>

        <div class="main-content">
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="home">Home</div>
                <div class="nav-tab" data-tab="admin">Admin</div>
            </div>

            <!-- Home -->
            <div class="tab-content active" id="home-tab">
                <div class="grid-section">
                    <h2 class="form-title"><i class="fas fa-th-large"></i> Application List</h2>
                    <div class="group-selector" id="group-filter"></div>
                    <div class="grid-container" id="home-grid-container"></div>
                    <div id="home-empty-message" class="empty-message">
                        <i class="fas fa-info-circle" style="font-size:2.4rem; margin-bottom:12px;"></i>
                        <p>No facilities added yet. Go to Admin page to add new facilities (connect GitHub first).</p>
                    </div>
                </div>
            </div>

            <!-- Admin -->
            <div class="tab-content" id="admin-tab">
                <div class="form-section">
                    <h2 class="form-title"><i class="fas fa-plus-circle"></i> Add New Application</h2>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="description">Description</label>
                            <input type="text" id="description" placeholder="Enter Application description" />
                        </div>
                        <div class="input-group">
                            <label for="url">URL Link</label>
                            <input type="text" id="url" placeholder="https://example.com" />
                        </div>
                        <div class="input-group">
                            <label for="group">Group</label>
                            <input type="text" id="group" placeholder="Enter group name" />
                        </div>
                        <div class="input-group">
                            <label for="icon">Icon</label>
                            <select id="icon">
                                <option value="fas fa-building">Building</option>
                                <option value="fas fa-wrench">Wrench</option>
                                <option value="fas fa-tools">Tools</option>
                                <option value="fas fa-laptop">Laptop</option>
                                <option value="fas fa-server">Server</option>
                                <option value="fas fa-network-wired">Network</option>
                                <option value="fas fa-warehouse">Warehouse</option>
                                <option value="fas fa-door-closed">Door</option>
                                <option value="fas fa-lightbulb">Lightbulb</option>
                                <option value="fas fa-camera">Camera</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="add-btn"><i class="fas fa-plus"></i> Add Application</button>
                    </div>
                </div>

                <div class="grid-section">
                    <h2 class="form-title"><i class="fas fa-list"></i> Manage Applications</h2>
                    <div class="grid-container" id="admin-grid-container"></div>
                    <div id="admin-empty-message" class="empty-message">
                        <i class="fas fa-info-circle" style="font-size:2.4rem; margin-bottom:12px;"></i>
                        <p>No facilities added yet. Start by adding a new facility above (connect GitHub first).</p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Facility Management Online Application &copy; 2023 â€” data stored in GitHub file</p>
        </footer>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Icon Modal (kept) -->
    <div class="modal" id="icon-modal">
        <div class="modal-content">
            <h2 class="modal-title">Select an Icon</h2>
            <div class="icon-options" id="icon-options"></div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                <button class="btn btn-ghost" id="cancel-icon-btn">Cancel</button>
                <button class="btn btn-primary" id="save-icon-btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // -------------------------
        // GitHub-backed storage notes:
        // - This implementation stores facility data in a JSON file in the specified GitHub repo (path).
        // - The page requires a Personal Access Token (PAT) with repo (or public_repo if storing in a public repo) scope.
        // - The PAT is kept in-memory only for the current session and NOT saved to localStorage by this app.
        // - For production use, you should move updates to a server or use a GitHub App to avoid exposing secrets in the browser.
        // -------------------------

        // DOM refs
        const ownerInput = document.getElementById('gh-owner');
        const repoInput = document.getElementById('gh-repo');
        const pathInput = document.getElementById('gh-path');
        const branchInput = document.getElementById('gh-branch');
        const tokenInput = document.getElementById('gh-token');
        const btnConnect = document.getElementById('btn-connect');
        const btnClear = document.getElementById('btn-clear');

        const homeGridContainer = document.getElementById('home-grid-container');
        const adminGridContainer = document.getElementById('admin-grid-container');
        const addBtn = document.getElementById('add-btn');
        const descriptionInput = document.getElementById('description');
        const urlInput = document.getElementById('url');
        const groupInput = document.getElementById('group');
        const iconSelect = document.getElementById('icon');
        const homeEmptyMessage = document.getElementById('home-empty-message');
        const adminEmptyMessage = document.getElementById('admin-empty-message');
        const notification = document.getElementById('notification');
        const iconModal = document.getElementById('icon-modal');
        const iconOptionsContainer = document.getElementById('icon-options');
        const cancelIconBtn = document.getElementById('cancel-icon-btn');
        const saveIconBtn = document.getElementById('save-icon-btn');
        const groupFilter = document.getElementById('group-filter');
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // State
        let ghConfig = null; // { owner, repo, path, branch, token }
        let currentEditId = null;
        let selectedIcon = null;
        let currentGroupFilter = 'all';
        const iconOptions = [
            'fas fa-building', 'fas fa-wrench', 'fas fa-tools', 'fas fa-laptop',
            'fas fa-server', 'fas fa-network-wired', 'fas fa-warehouse', 'fas fa-door-closed',
            'fas fa-lightbulb', 'fas fa-camera', 'fas fa-desktop', 'fas fa-plug',
            'fas fa-wifi', 'fas fa-thermometer-half', 'fas fa-shield-alt', 'fas fa-key'
        ];

        // Helper: show notification
        function showNotification(msg, type='success') {
            notification.textContent = msg;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Helper: basic URL check
        function isValidUrl(url) {
            try { new URL(url); return true; } catch (e) { return false; }
        }

        // GitHub helper utilities
        function getHeaders() {
            return {
                'Accept': 'application/vnd.github.v3+json',
                'Authorization': `token ${ghConfig.token}`
            };
        }

        // base64 encode Unicode-safe
        function toBase64Unicode(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }
        function fromBase64Unicode(b64) {
            try {
                return decodeURIComponent(escape(atob(b64)));
            } catch (e) {
                // fallback
                return atob(b64);
            }
        }

        // GitHub File API wrapper
        const ghAPI = {
            // fetch the file contents; returns { content: string, sha } or null if not exists
            async getFile() {
                const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${encodeURIComponent(ghConfig.path)}?ref=${encodeURIComponent(ghConfig.branch)}`;
                const res = await fetch(url, { headers: getHeaders() });
                if (res.status === 404) return null;
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`GitHub getFile failed: ${res.status} ${txt}`);
                }
                const json = await res.json();
                const content = fromBase64Unicode(json.content.replace(/\n/g, ''));
                return { content, sha: json.sha };
            },

            // create or update file with newContent (string). Pass sha to update existing file.
            async putFile(newContent, message = 'Update facilities') {
                const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${encodeURIComponent(ghConfig.path)}`;
                // get existing file to set sha (create if null)
                const existing = await ghAPI.getFile();
                const body = {
                    message,
                    content: toBase64Unicode(newContent),
                    branch: ghConfig.branch
                };
                if (existing && existing.sha) body.sha = existing.sha;
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`GitHub putFile failed: ${res.status} ${txt}`);
                }
                return await res.json();
            },

            // delete the file (used only if you want to remove whole file)
            async deleteFile(message = 'Delete file') {
                const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${encodeURIComponent(ghConfig.path)}`;
                const existing = await ghAPI.getFile();
                if (!existing || !existing.sha) return null;
                const body = { message, sha: existing.sha, branch: ghConfig.branch };
                const res = await fetch(url, {
                    method: 'DELETE',
                    headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`GitHub deleteFile failed: ${res.status} ${txt}`);
                }
                return await res.json();
            }
        };

        // Server API mapped to GitHub file
        const serverAPI = {
            async getFacilities() {
                if (!ghConfig) throw new Error('GitHub not configured');
                const file = await ghAPI.getFile();
                if (!file) return []; // treat missing file as empty
                try {
                    const data = JSON.parse(file.content || '[]');
                    return Array.isArray(data) ? data : [];
                } catch (e) {
                    console.error('Invalid JSON in GitHub file, returning empty array', e);
                    return [];
                }
            },

            async addFacility(facility) {
                if (!ghConfig) throw new Error('GitHub not configured');
                // get current facilities, push new, write back
                const facilities = await this.getFacilities();
                facility.id = Date.now(); // simple unique ID
                facilities.push(facility);
                await ghAPI.putFile(JSON.stringify(facilities, null, 2), `Add facility ${facility.description}`);
                return facility;
            },

            async updateFacility(id, updates) {
                if (!ghConfig) throw new Error('GitHub not configured');
                const facilities = await this.getFacilities();
                const idx = facilities.findIndex(f => f.id === id);
                if (idx === -1) throw new Error('Facility not found');
                facilities[idx] = { ...facilities[idx], ...updates };
                await ghAPI.putFile(JSON.stringify(facilities, null, 2), `Update facility ${id}`);
                return facilities[idx];
            },

            async deleteFacility(id) {
                if (!ghConfig) throw new Error('GitHub not configured');
                let facilities = await this.getFacilities();
                facilities = facilities.filter(f => f.id !== id);
                await ghAPI.putFile(JSON.stringify(facilities, null, 2), `Delete facility ${id}`);
                return { success: true };
            }
        };

        // UI logic (mostly reused from original but using serverAPI)
        async function loadHomeGridData() {
            try {
                const facilities = await serverAPI.getFacilities();
                homeGridContainer.innerHTML = '';

                const filteredFacilities = currentGroupFilter === 'all'
                    ? facilities
                    : facilities.filter(fac => fac.group === currentGroupFilter);

                filteredFacilities.forEach(facility => {
                    const card = document.createElement('a');
                    card.className = 'facility-card';
                    card.href = facility.url;
                    card.target = '_blank';
                    card.innerHTML = `
                        <div class="card-icon"><i class="${facility.icon}"></i></div>
                        <div class="card-group">${facility.group}</div>
                        <div class="card-title">${facility.description}</div>
                    `;
                    homeGridContainer.appendChild(card);
                });
            } catch (e) {
                console.error(e);
                showNotification('Error loading facilities (check GitHub config)', 'error');
                homeGridContainer.innerHTML = '';
            }
        }

        async function loadAdminGridData() {
            try {
                const facilities = await serverAPI.getFacilities();
                adminGridContainer.innerHTML = '';

                facilities.forEach(facility => {
                    const card = document.createElement('div');
                    card.className = 'facility-card admin-card';
                    card.setAttribute('data-id', facility.id);
                    card.innerHTML = `
                        <div class="card-icon" style="cursor:pointer"><i class="${facility.icon}"></i></div>
                        <div class="card-group">${facility.group}</div>
                        <div class="card-title" style="cursor:pointer">${facility.description}</div>
                        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center">
                            <button class="btn-edit" data-action="edit-url" data-id="${facility.id}"><i class="fas fa-edit"></i> Edit URL</button>
                            <button class="btn-edit" data-action="edit-title" data-id="${facility.id}"><i class="fas fa-edit"></i> Edit Title</button>
                            <button class="btn-edit" data-action="edit-group" data-id="${facility.id}"><i class="fas fa-tag"></i> Edit Group</button>
                            <button class="btn-delete" data-action="delete" data-id="${facility.id}"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    `;
                    adminGridContainer.appendChild(card);
                });
            } catch (e) {
                console.error(e);
                showNotification('Error loading admin grid (check GitHub config)', 'error');
                adminGridContainer.innerHTML = '';
            }
        }

        async function addFacility(description, url, group, icon) {
            const newFacility = { description, url, group, icon };
            await serverAPI.addFacility(newFacility);
            await reloadAll();
            showNotification('Facility added', 'success');
        }

        async function deleteFacilityById(id) {
            if (!confirm('Are you sure you want to delete this facility?')) return;
            try {
                await serverAPI.deleteFacility(id);
                await reloadAll();
                showNotification('Facility deleted', 'success');
            } catch (e) {
                console.error(e);
                showNotification('Error deleting (check GitHub config)', 'error');
            }
        }

        async function updateFacilityById(id, field, value) {
            try {
                await serverAPI.updateFacility(id, { [field]: value });
                await reloadAll();
                showNotification('Facility updated', 'success');
            } catch (e) {
                console.error(e);
                showNotification('Error updating (check GitHub config)', 'error');
            }
        }

        // Utility to reload both lists & groups
        async function reloadAll() {
            await setupGroupFilters();
            await loadHomeGridData();
            await loadAdminGridData();
            await updateEmptyMessages();
        }

        // Event wiring
        addBtn.addEventListener('click', async () => {
            if (!ghConfig) { showNotification('Please connect to GitHub first', 'error'); return; }
            const description = descriptionInput.value.trim();
            const url = urlInput.value.trim();
            const group = groupInput.value.trim() || 'General';
            const icon = iconSelect.value;
            if (!description) { showNotification('Please enter a description', 'error'); return; }
            if (!isValidUrl(url)) { showNotification('Please enter a valid URL (include http:// or https://)', 'error'); return; }
            addBtn.disabled = true;
            addBtn.innerHTML = '<span class="loading"></span> Adding...';
            try {
                await addFacility(description, url, group, icon);
                descriptionInput.value = ''; urlInput.value = ''; groupInput.value = '';
            } catch (e) {
                console.error(e);
                showNotification('Error adding facility (check GitHub config)', 'error');
            } finally {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Add Application';
            }
        });

        // Admin grid click handling using event delegation
        adminGridContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const action = target.getAttribute('data-action');
            const id = Number(target.getAttribute('data-id'));
            if (action === 'delete') {
                await deleteFacilityById(id);
            } else if (action === 'edit-title') {
                makeTitleEditable(id);
            } else if (action === 'edit-group') {
                makeGroupEditable(id);
            } else if (action === 'edit-url') {
                makeUrlEditable(id);
            }
        });

        // editable handlers
        function makeTitleEditable(id) {
            const card = document.querySelector(`.admin-card[data-id="${id}"]`);
            const titleDiv = card.querySelector('.card-title');
            const current = titleDiv.textContent;
            const input = document.createElement('input');
            input.type = 'text'; input.value = current; input.className = 'editable-input';
            titleDiv.replaceWith(input); input.focus();
            input.addEventListener('blur', () => saveTitle(id, input.value));
            input.addEventListener('keyup', (ev) => { if (ev.key === 'Enter') saveTitle(id, input.value); });
        }
        async function saveTitle(id, newTitle) {
            if (newTitle.trim()) await updateFacilityById(id, 'description', newTitle.trim());
        }

        function makeGroupEditable(id) {
            const card = document.querySelector(`.admin-card[data-id="${id}"]`);
            const groupDiv = card.querySelector('.card-group');
            const current = groupDiv.textContent;
            const input = document.createElement('input');
            input.type = 'text'; input.value = current; input.className = 'editable-input';
            groupDiv.replaceWith(input); input.focus();
            input.addEventListener('blur', () => saveGroup(id, input.value));
            input.addEventListener('keyup', (ev) => { if (ev.key === 'Enter') saveGroup(id, input.value); });
        }
        async function saveGroup(id, newGroup) {
            if (newGroup.trim()) await updateFacilityById(id, 'group', newGroup.trim());
        }

        async function makeUrlEditable(id) {
            const card = document.querySelector(`.admin-card[data-id="${id}"]`);
            const actions = card.querySelector('div[style*="display:flex"]');
            const currentUrl = await (async () => {
                const facilities = await serverAPI.getFacilities();
                const f = facilities.find(x => x.id === id);
                return f ? f.url : '';
            })();
            actions.innerHTML = '';
            const input = document.createElement('input'); input.type = 'text'; input.value = currentUrl; input.className = 'editable-input'; input.placeholder = 'Enter new URL';
            const saveBtn = document.createElement('button'); saveBtn.className = 'btn-edit'; saveBtn.innerHTML = '<i class="fas fa-save"></i> Save URL';
            const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn-delete'; cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
            actions.appendChild(input); actions.appendChild(saveBtn); actions.appendChild(cancelBtn);
            input.focus();
            saveBtn.onclick = async () => {
                if (!isValidUrl(input.value.trim())) { showNotification('Please enter a valid URL', 'error'); await reloadAll(); return; }
                await updateFacilityById(id, 'url', input.value.trim());
            };
            cancelBtn.onclick = async () => await loadAdminGridData();
        }

        // Icon modal (similar to original)
        function populateIconOptions() {
            iconOptionsContainer.innerHTML = '';
            iconOptions.forEach(ic => {
                const opt = document.createElement('div');
                opt.className = 'icon-option';
                opt.innerHTML = `<i class="${ic}"></i><span style="font-size:0.8rem;margin-top:6px">${ic.split('fa-')[1] || ic}</span>`;
                opt.addEventListener('click', () => {
                    selectedIcon = ic;
                    document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                });
                iconOptionsContainer.appendChild(opt);
            });
        }
        populateIconOptions();

        // Icon modal open/save/cancel handlers
        let iconEditTargetId = null;
        document.addEventListener('click', (e) => {
            const iconEl = e.target.closest('.card-icon');
            if (!iconEl) return;
            const card = iconEl.closest('.admin-card');
            if (!card) return;
            const id = Number(card.getAttribute('data-id'));
            openIconModal(id);
        });

        async function openIconModal(id) {
            iconEditTargetId = id;
            // set selectedIcon from facility
            const facs = await serverAPI.getFacilities();
            const f = facs.find(x => x.id === id);
            selectedIcon = f ? f.icon : iconOptions[0];
            // highlight
            document.querySelectorAll('.icon-option').forEach(o => {
                const i = o.querySelector('i').className;
                if (i === selectedIcon) o.classList.add('selected'); else o.classList.remove('selected');
            });
            iconModal.style.display = 'flex';
        }

        saveIconBtn.addEventListener('click', async () => {
            if (!iconEditTargetId || !selectedIcon) { iconModal.style.display = 'none'; return; }
            try {
                await updateFacilityById(iconEditTargetId, 'icon', selectedIcon);
                iconModal.style.display = 'none';
            } catch (e) {
                console.error(e);
                showNotification('Error updating icon (check GitHub config)', 'error');
            }
        });

        cancelIconBtn.addEventListener('click', () => {
            iconModal.style.display = 'none';
        });

        // Group filters
        async function setupGroupFilters() {
            try {
                const facilities = await serverAPI.getFacilities();
                const groups = ['all', ...new Set(facilities.map(f => f.group))];
                groupFilter.innerHTML = '';
                groups.forEach(g => {
                    const btn = document.createElement('div');
                    btn.className = `group-btn ${g === currentGroupFilter ? 'active' : ''}`;
                    btn.textContent = g === 'all' ? 'All Groups' : g;
                    btn.addEventListener('click', async () => {
                        currentGroupFilter = g;
                        await reloadAll();
                    });
                    groupFilter.appendChild(btn);
                });
            } catch (e) {
                // if not configured yet, show only All
                groupFilter.innerHTML = `<div class="group-btn active">All Groups</div>`;
            }
        }

        async function updateEmptyMessages() {
            try {
                const facilities = await serverAPI.getFacilities();
                homeEmptyMessage.style.display = facilities.length === 0 ? 'block' : 'none';
                adminEmptyMessage.style.display = facilities.length === 0 ? 'block' : 'none';
            } catch (e) {
                homeEmptyMessage.style.display = 'block';
                adminEmptyMessage.style.display = 'block';
            }
        }

        // Tab navigation
        navTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                const tabId = tab.getAttribute('data-tab');
                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}-tab`).classList.add('active');
                if (tabId === 'admin') await loadAdminGridData();
            });
        });

        // Connect button: validate GitHub access and load data
        btnConnect.addEventListener('click', async () => {
            const owner = ownerInput.value.trim();
            const repo = repoInput.value.trim();
            const path = pathInput.value.trim() || 'data/facilities.json';
            const branch = branchInput.value.trim() || 'main';
            const token = tokenInput.value.trim();
            if (!owner || !repo || !token) { showNotification('Please fill owner, repo and token', 'error'); return; }
            ghConfig = { owner, repo, path, branch, token };
            // quick validation: try to get file (if 404 it's fine), or test repo access via repo endpoint
            try {
                // Check repo access
                const testUrl = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}`;
                const res = await fetch(testUrl, { headers: getHeaders() });
                if (!res.ok) {
                    const txt = await res.text();
                    ghConfig = null;
                    throw new Error(`Cannot access repo: ${res.status} ${txt}`);
                }
                showNotification('Connected to GitHub', 'success');
                await reloadAll();
            } catch (e) {
                console.error(e);
                ghConfig = null;
                showNotification('Failed to connect: check token and repo', 'error');
            }
        });

        // Clear configuration (only in-memory)
        btnClear.addEventListener('click', () => {
            ghConfig = null;
            ownerInput.value = ''; repoInput.value = ''; pathInput.value = 'data/facilities.json'; branchInput.value = 'main'; tokenInput.value = '';
            showNotification('Cleared GitHub configuration', 'success');
            // clear UI lists
            homeGridContainer.innerHTML = '';
            adminGridContainer.innerHTML = '';
            groupFilter.innerHTML = '';
            homeEmptyMessage.style.display = 'block';
            adminEmptyMessage.style.display = 'block';
        });

        // On load: don't auto-use localStorage for data; wait for user to connect
        document.addEventListener('DOMContentLoaded', () => {
            // Provide guidance in console
            console.info('This app stores facility data in a GitHub repo file. Provide owner/repo/branch/path and a personal access token (PAT) with repo/public_repo scope.');
            // initialize UI placeholders
            setupGroupFilters();
            updateEmptyMessages();
        });

        // Expose deleteFacility to global scope for backward compatibility (not required)
        window.deleteFacility = async (id) => await deleteFacilityById(id);

    </script>
</body>
</html>
