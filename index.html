<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Management Online Application</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles to complement Tailwind CSS */
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc; /* Lighter gray background */
        }
        .nav-tab.active {
            border-bottom-color: #3b82f6; /* Tailwind blue-500 */
            color: #3b82f6;
            background-color: white;
        }
        .loading {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for editable input fields */
        .editable-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center my-8">
            <h1 class="text-3xl md:text-5xl font-bold text-slate-800 flex items-center justify-center gap-4">
                <i class="fas fa-building text-blue-500"></i>
                <span>Facility Management</span>
            </h1>
            <p class="text-slate-500 mt-2 text-lg">Your central hub for all facility applications, securely stored on the server.</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="border-b border-slate-200">
                <div class="nav-tabs flex">
                    <div class="nav-tab active cursor-pointer py-4 px-6 font-semibold text-slate-500 border-b-2 border-transparent transition-all" data-tab="home">Home</div>
                    <div class="nav-tab cursor-pointer py-4 px-6 font-semibold text-slate-500 border-b-2 border-transparent transition-all" data-tab="admin">Admin</div>
                </div>
            </div>

            <!-- Home Tab Content -->
            <div class="tab-content active p-4 md:p-8" id="home-tab">
                <div class="grid-section">
                    <h2 class="text-2xl font-bold text-slate-700 flex items-center gap-3 mb-4"><i class="fas fa-th-large text-blue-500"></i> Application List</h2>
                    <div class="group-selector flex flex-wrap gap-2 mb-6" id="group-filter">
                        <!-- Group filters will be added dynamically -->
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="home-grid-container">
                        <!-- Grid cards will be added here dynamically -->
                    </div>
                    <div id="home-empty-message" class="text-center py-16 text-slate-500 hidden">
                        <i class="fas fa-info-circle text-5xl mb-4 text-slate-400"></i>
                        <p class="text-lg">No facilities found. An administrator needs to add them in the 'Admin' tab.</p>
                    </div>
                </div>
            </div>

            <!-- Admin Tab Content -->
            <div class="tab-content hidden p-4 md:p-8" id="admin-tab">
                <div class="form-section bg-slate-50 p-6 rounded-lg border border-slate-200 mb-8">
                    <h2 class="text-2xl font-bold text-slate-700 flex items-center gap-3 mb-6"><i class="fas fa-plus-circle text-blue-500"></i> Add New Application</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <div class="input-group">
                            <label for="description" class="block mb-1 text-sm font-medium text-slate-600">Description</label>
                            <input type="text" id="description" placeholder="e.g., HVAC Control Panel" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div class="input-group">
                            <label for="url" class="block mb-1 text-sm font-medium text-slate-600">URL Link</label>
                            <input type="text" id="url" placeholder="https://..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div class="input-group">
                            <label for="group" class="block mb-1 text-sm font-medium text-slate-600">Group</label>
                            <input type="text" id="group" placeholder="e.g., Maintenance" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                         <div class="input-group">
                            <label for="icon" class="block mb-1 text-sm font-medium text-slate-600">Icon</label>
                            <select id="icon" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                <option value="fas fa-building">Building</option>
                                <option value="fas fa-wrench">Wrench</option>
                                <option value="fas fa-tools">Tools</option>
                                <option value="fas fa-laptop">Laptop</option>
                                <option value="fas fa-server">Server</option>
                                <option value="fas fa-network-wired">Network</option>
                                <option value="fas fa-warehouse">Warehouse</option>
                                <option value="fas fa-door-closed">Door</option>
                                <option value="fas fa-lightbulb">Lightbulb</option>
                                <option value="fas fa-camera">Camera</option>
                            </select>
                        </div>
                        <button id="add-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition-all shadow hover:shadow-md flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>

                <div class="grid-section">
                     <h2 class="text-2xl font-bold text-slate-700 flex items-center gap-3 mb-6"><i class="fas fa-list text-blue-500"></i> Manage Applications</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="admin-grid-container">
                        <!-- Admin grid cards will be added here dynamically -->
                    </div>
                    <div id="admin-empty-message" class="text-center py-16 text-slate-500 hidden">
                        <i class="fas fa-info-circle text-5xl mb-4 text-slate-400"></i>
                        <p class="text-lg">No facilities added yet. Start by adding a new one above.</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center py-6">
            <p class="text-slate-500">Facility Management &copy; 2025 | All data stored securely on the server.</p>
        </footer>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed top-5 right-5 p-4 rounded-lg text-white shadow-lg transform translate-x-full transition-transform duration-300"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // IMPORTANT: Create a Firebase project and paste your web app's configuration here.
        // Go to Project settings > General > Your apps > Web app > Firebase SDK snippet > Config
        const firebaseConfig = JSON.parse(
            typeof __firebase_config !== 'undefined' 
            ? __firebase_config 
            : '{ "apiKey": "YOUR_API_KEY", "authDomain": "YOUR_PROJECT_ID.firebaseapp.com", "projectId": "YOUR_PROJECT_ID", "storageBucket": "YOUR_PROJECT_ID.appspot.com", "messagingSenderId": "YOUR_SENDER_ID", "appId": "YOUR_APP_ID" }'
        );
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'facility-management-app';

        // --- DOM Elements ---
        const homeGridContainer = document.getElementById('home-grid-container');
        const adminGridContainer = document.getElementById('admin-grid-container');
        const addBtn = document.getElementById('add-btn');
        const descriptionInput = document.getElementById('description');
        const urlInput = document.getElementById('url');
        const groupInput = document.getElementById('group');
        const iconSelect = document.getElementById('icon');
        const homeEmptyMessage = document.getElementById('home-empty-message');
        const adminEmptyMessage = document.getElementById('admin-empty-message');
        const notification = document.getElementById('notification');
        const groupFilter = document.getElementById('group-filter');

        // --- App State ---
        let currentGroupFilter = 'all';
        let facilitiesCache = []; // Local cache of facilities
        let facilitiesColRef; // Firestore collection reference
        let unsubscribe; // To detach the onSnapshot listener

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                console.log("Authenticated User ID:", user.uid);
                // Define the collection path using the user's unique ID for data security
                facilitiesColRef = collection(db, `artifacts/${appId}/users/${user.uid}/facilities`);
                listenForFacilities(); // Start listening for real-time data
            } else {
                console.log("User is not authenticated.");
                if (unsubscribe) unsubscribe(); // Stop listening if user logs out
            }
        });

        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                showNotification("Authentication failed. Please check your Firebase setup.", "error");
            }
        }

        // --- Real-time Data Listener ---
        function listenForFacilities() {
            if (unsubscribe) unsubscribe();
            if (!facilitiesColRef) return;

            unsubscribe = onSnapshot(facilitiesColRef, (snapshot) => {
                let facilities = [];
                snapshot.forEach(doc => {
                    facilities.push({ ...doc.data(), id: doc.id });
                });
                // Sort in memory to avoid needing complex Firestore indexes
                facilities.sort((a, b) => (a.group || '').localeCompare(b.group || ''));
                facilitiesCache = facilities;
                renderAll(facilitiesCache);
            }, (error) => {
                console.error("Error listening to facilities:", error);
                showNotification("Error fetching real-time data.", "error");
            });
        }
        
        // --- Firestore CRUD Functions ---
        async function addFacility() {
            const description = descriptionInput.value.trim();
            const url = urlInput.value.trim();
            const group = groupInput.value.trim() || 'General';
            const icon = iconSelect.value;

            if (!description || !url) {
                return showNotification('Description and URL are required.', 'error');
            }
            if (!isValidUrl(url)) {
                return showNotification('Please enter a valid URL (e.g., https://example.com)', 'error');
            }
            
            setButtonLoading(addBtn, true, 'Adding...');
            try {
                await addDoc(facilitiesColRef, { description, url, group, icon, createdAt: Date.now() });
                showNotification('Application added successfully!', 'success');
                descriptionInput.value = '';
                urlInput.value = '';
                groupInput.value = '';
            } catch (error) {
                console.error("Error adding facility: ", error);
                showNotification('Failed to add application.', 'error');
            } finally {
                setButtonLoading(addBtn, false, '<i class="fas fa-plus"></i> Add');
            }
        }

        async function deleteFacility(id) {
            // Using a custom modal instead of confirm()
            if (!await showConfirmation('Are you sure you want to delete this facility?')) return;
            try {
                const docRef = doc(db, facilitiesColRef.path, id);
                await deleteDoc(docRef);
                showNotification('Application deleted.', 'success');
            } catch (error) {
                console.error("Error deleting facility: ", error);
                showNotification('Failed to delete application.', 'error');
            }
        }

        async function updateFacility(id, data) {
             try {
                const docRef = doc(db, facilitiesColRef.path, id);
                await updateDoc(docRef, data);
                showNotification('Application updated.', 'success');
            } catch (error) {
                console.error("Error updating facility: ", error);
                showNotification('Failed to update application.', 'error');
            }
        }

        // --- Rendering Logic ---
        function renderAll(facilities) {
            renderHomeGrid(facilities);
            renderAdminGrid(facilities);
            setupGroupFilters(facilities);
            updateEmptyMessages(facilities);
        }

        function renderHomeGrid(facilities) {
            homeGridContainer.innerHTML = '';
            const filtered = currentGroupFilter === 'all'
                ? facilities
                : facilities.filter(f => f.group === currentGroupFilter);

            filtered.forEach(facility => {
                const card = document.createElement('a');
                card.href = facility.url;
                card.target = '_blank';
                card.className = 'facility-card block bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all text-center';
                card.innerHTML = `
                    <div class="card-icon text-5xl text-blue-500 mb-4"><i class="${facility.icon}"></i></div>
                    <div class="card-title text-slate-800 font-bold text-lg mb-2 truncate" title="${facility.description}">${facility.description}</div>
                    <div class="card-group text-xs text-slate-500 bg-slate-100 rounded-full inline-block px-3 py-1">${facility.group}</div>
                `;
                homeGridContainer.appendChild(card);
            });
        }

        function renderAdminGrid(facilities) {
            adminGridContainer.innerHTML = '';
            facilities.forEach(facility => {
                const card = document.createElement('div');
                card.className = 'admin-card bg-white p-4 rounded-lg shadow-md flex flex-col items-center text-center space-y-3';
                card.innerHTML = `
                    <div class="card-icon text-5xl text-blue-500"><i class="${facility.icon}"></i></div>
                    <div class="card-title text-slate-800 font-bold w-full truncate" data-field="description">${facility.description}</div>
                    <div class="card-group text-sm text-slate-600 w-full truncate" data-field="group">${facility.group}</div>
                    <div class="card-url text-xs text-blue-500 w-full truncate" data-field="url" title="${facility.url}">${facility.url}</div>
                    <div class="card-actions flex gap-2 mt-2">
                        <button class="edit-btn bg-green-500 hover:bg-green-600 text-white text-xs px-3 py-1 rounded-full transition"><i class="fas fa-edit"></i> Edit</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-full transition"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                `;
                // Add event listeners directly to the buttons
                card.querySelector('.delete-btn').addEventListener('click', () => deleteFacility(facility.id));
                card.querySelector('.edit-btn').addEventListener('click', (e) => {
                    const parent = e.target.closest('.admin-card');
                    parent.querySelectorAll('[data-field]').forEach(el => makeEditable(el, facility.id));
                    e.target.innerHTML = '<i class="fas fa-save"></i> Save';
                    e.target.classList.remove('bg-green-500', 'hover:bg-green-600');
                    e.target.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    e.target.onclick = () => saveEditable(parent, facility.id);
                });
                adminGridContainer.appendChild(card);
            });
        }

        // --- UI & Event Handlers ---
        
        function makeEditable(element, id) {
            const currentValue = element.textContent;
            const field = element.dataset.field;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.className = 'editable-input mt-1';
            input.dataset.field = field;
            element.replaceWith(input);
            if (field === "description") input.focus();
        }
        
        async function saveEditable(card, id) {
            const updates = {};
            card.querySelectorAll('input[data-field]').forEach(input => {
                updates[input.dataset.field] = input.value.trim();
            });
            await updateFacility(id, updates);
            // The onSnapshot listener will handle re-rendering automatically
        }

        function setupGroupFilters(facilities) {
            const groups = ['all', ...new Set(facilities.map(f => f.group).filter(Boolean))];
            groupFilter.innerHTML = '';
            groups.forEach(group => {
                const btn = document.createElement('button');
                btn.textContent = group === 'all' ? 'All Groups' : group;
                btn.className = `px-4 py-1.5 text-sm rounded-full transition ${currentGroupFilter === group ? 'bg-blue-500 text-white font-semibold' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`;
                btn.onclick = () => {
                    currentGroupFilter = group;
                    renderAll(facilitiesCache);
                };
                groupFilter.appendChild(btn);
            });
        }

        function updateEmptyMessages(facilities) {
            const isEmpty = facilities.length === 0;
            homeEmptyMessage.style.display = isEmpty ? 'block' : 'none';
            adminEmptyMessage.style.display = isEmpty ? 'block' : 'none';
        }

        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `fixed top-5 right-5 p-4 rounded-lg text-white shadow-lg transform transition-transform duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} translate-x-0`;
            setTimeout(() => {
                notification.classList.add('translate-x-full');
            }, 3000);
        }

        function setButtonLoading(button, isLoading, loadingText) {
            button.disabled = isLoading;
            if (isLoading) {
                button.innerHTML = `<div class="loading mr-2"></div> ${loadingText}`;
            } else {
                button.innerHTML = loadingText;
            }
        }
        
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showConfirmation(message) {
            return new Promise(resolve => {
                // For simplicity in a single file, this is a basic confirmation.
                // In a real app, you'd build a custom modal UI.
                const result = window.confirm(message);
                resolve(result);
            });
        }

        // Tab switching logic
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            });
        });

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            addBtn.addEventListener('click', addFacility);
            signIn();
        });

    </script>
</body>
</html>
